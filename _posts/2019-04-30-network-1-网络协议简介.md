---
title: 网络协议简介一
date: 2019-04-30
categories:
- Tech
- network
- tcp/ip
tags:
- blog
- network
- tcp/ip
---
  
> 啊，你好吗？  
... （问候消失在无垠的宇宙中）  
  
> 旅行者一号一直播报人类的声音  
  
> 不要回答，不要回答，不要回答，大刘的告诫  
  
  
网络协议简介  
用于确定数据传输方式，并保证一定的传输质量  
  
OSI七层模型  
应用层  
表示层  
会话层  
传输层  
网络层  
数据链路层  
物理层  
  
TCP/IP协议层次  
应用层  
传输层：TCP/UDP  
网络层：IPv4/IPv6  
设备驱动和硬件  
  
如何使用套接字编写使用TCP/UDP的网络应用程序  
如何绕过IP层直接读取数据链路层的帧  
通信需要关注的地方：发送数据，等待确认，给无序到达的数据排序，计算并验证校验和  
  
  
传输层需要了解的主题  
TCP的三路握手，TCP的连接终止序列和TCP的TIME_WAIT状态  
由套接字层提供的TCP、UDP缓冲机制  
  
  
tcpdump程序不使用套接字  
直接读取数据链路层的数据  
  
UDP，用户数据报协议  
简单的传输层协议，  
应用程序往一个UDP套接字写入一个消息后，该消息随后被封装到一个UDP数据保  
该数据报又被封进一个IP数据报，然后发往目的地  
不保证一定到达，不保证只到达一份，不保证到达的是正确的，不保证达到的顺序和发送的顺序相同  
  
但是，每个UDP数据报都有一个长度。如果一个数据报正确到达其目的地，  
那么该数据报的长度将随数据一起传递给接收端的应用程序。  
  
TCP，传输控制协议  
首先，建立连接，是连接的，虚拟连接  
提供可靠性，  
确认，  
超时，重传  
动态估算客户和服务之间的往返时间，  
通过序列号对每次发送的数据包进行排序  
提供流量控制，每次通过窗口告知缓冲区大小，保证不溢出  
全双工的，也可以设置成单工的  
所以，连接的，可靠的，确认，超时，重传，往返时间估算，排序的，窗口调节，流量控制  
  
TCP的两次发送之间是没有界线的，也就是说，如果客户端调用两次TCP发送，那么服务端是分不出这两次的界线的。  
  
  
TCP的连接的建立和终止  
三路握手  
C --  SYC -->     S  
C <-- ACK SYNC -- S  
C --  ACK -->    S  
  
TCP选项  
MSS，最大分节大小  
窗口选项，TCP自动调节，不需应用程序调节，可配置  
时间戳选项，TCP自动调节  
  
连接终止，四路分手  
主动关闭端可以是服务端，可以是客户端  
主动关闭端  -- FIN M -->   被动关闭端  
主动关闭端  <-- ACK M+1 --   被动关闭端  
主动关闭端  <-- FIN N --   被动关闭端  
主动关闭端  -- ACK N+1 -->   被动关闭端  
  
TCP状态转换图  
11个状态  
LISTEN  
SYN_SENT  
SYN_RCVD  
ESTABLISHED  
ESTABLISHED  
  
FIN_WAIT_1  
CLOSE_WAIT  
FIN_WAIT_2  
LAST_ACK  
TIME_WAIT  
CLOSED  
  
  
每个分组和状态之间的关系  
  
  
TIME_WAIT状态：  
MSL，maximum segment lifetime，网络中一个分节最长生存时间  
使得丢失的环节可以重新发送，  
使得老的重复分节在网络中消逝，如果不等待这么长时间，老的重复分节再次到来，会引起错误序列的接收和处理，*如果收到了，当前TCP是怎么处理的呢？*  
主动关闭端有一个TIME_WAIT状态，保证有一个可靠的关闭连接  
如果需要服务端主动关闭，在服务端这么多的TIME_WAIT状态会不会就使得端口严重占用？  
  
端口号  
知名端口号，0-1023  
挂名端口号  
临时端口号  
  
TCP端口号与并发服务器  
服务端监听一个端口号，客户端连接请求到达后，服务端打开一个临时端口，  
服务端使用临时端口号和客户端进行通信，  
  
  
缓冲区大小及限制  
- IPv4数据报的最大是65535，包括IPv4首部  
- IPv6数据报的最大是65575，包括40字节首部  
- 许多网络有硬件规定的MTU  
- 两个主机之间的路径最小的MTU称为路径MTU  
- 当一个IP数据报将从某个接口送出时，如果大小超过路径MTU，IPv4和IPv6会执行分片  
- IPv4的首部不分片标识位，若被设置，则不允许分片，若超过路由器MTU，则返ICMPv4错误  
- IPv4和IPv6都定义了最小重组缓冲区大小，分别为576和1440，minimum reassemly buffer size，实现必须支持这个  
- TCP有一个MSS，最大分节大小，用于向对端告知其能接收的最大的TCP数据量，通常根据MTU进行设置，以避免MTU分片  
  
如果TCP缓冲区不足，那么write会阻塞，直到放入缓冲区  
如果UDP缓冲区不足，那么write直接返错  
write操作返回后，只是表明数据放入了缓冲区，TCP保证一定会发送，TCP层收到对端发送的确认之后才会丢弃数据并释放空间。  
  
TCP先按照MSS将应用程序的数据分成片，然后可能不会在IP层进行MTU分片  
UDP不会进行分片，将应用程序所有的数据送到IP层，在IP层执行MTU分片  
  
  
  
---------------------------------------  
根据以上概念，在编写网络服务器时，需要考虑的内容  
  
端口号的使用量，标志着可以同时进行的连接  
使用面向连接的还是无连接的  
使用长连接还是短连接  
数据拷贝，分片，内核空间和用户空间的切换  
缓冲区的大小的设置和期望的性能  
硬件性能和应用程序的调试  
谁主动断开连接  
如何处理WAIT_TIME状态  
端口重用  
  
端口  
套接字  
信号  
线程  
进程  
端口复用  
套接字选项配置，ip/tcp/udp选项  
异步IO，非阻塞IO  
常用编程接口  
Unix域协议，路由，广播，多播，带外数据，原始套接字，密钥套接字  
它们之间的关系  
  
---------------------------------------  
